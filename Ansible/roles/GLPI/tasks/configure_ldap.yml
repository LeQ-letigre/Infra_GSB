---
# Configuration LDAP automatique pour GLPI
# Ce fichier configure l'authentification LDAP/Active Directory dans GLPI

- name: Attendre que GLPI soit complètement démarré
  ansible.builtin.wait_for:
    timeout: 10
  delegate_to: localhost

- name: Créer un fichier SQL temporaire pour la configuration LDAP
  ansible.builtin.copy:
    content: |
      INSERT INTO glpi_authldaps (
        name, host, port, basedn, rootdn, rootdn_passwd,
        login_field, sync_field, `condition`,
        use_tls, use_bind, use_dn,
        email1_field, realname_field, firstname_field, phone_field, title_field,
        is_active, is_default, date_creation, date_mod
      ) VALUES (
        '{{ glpi_ldap_name }}',
        '{{ glpi_ldap_host }}',
        {{ glpi_ldap_port }},
        '{{ glpi_ldap_basedn }}',
        '{{ glpi_ldap_rootdn }}',
        '{{ glpi_ldap_password }}',
        '{{ glpi_ldap_login_field }}',
        '{{ glpi_ldap_sync_field }}',
        '{{ glpi_ldap_condition }}',
        {{ '1' if glpi_ldap_use_tls else '0' }},
        {{ '1' if glpi_ldap_use_bind else '0' }},
        {{ '1' if glpi_ldap_use_dn else '0' }},
        '{{ glpi_ldap_email1_field }}',
        '{{ glpi_ldap_realname_field }}',
        '{{ glpi_ldap_firstname_field }}',
        '{{ glpi_ldap_phone_field }}',
        '{{ glpi_ldap_title_field }}',
        1,
        1,
        NOW(),
        NOW()
      ) ON DUPLICATE KEY UPDATE
        host = '{{ glpi_ldap_host }}',
        port = {{ glpi_ldap_port }},
        basedn = '{{ glpi_ldap_basedn }}',
        rootdn = '{{ glpi_ldap_rootdn }}',
        rootdn_passwd = '{{ glpi_ldap_password }}',
        login_field = '{{ glpi_ldap_login_field }}',
        sync_field = '{{ glpi_ldap_sync_field }}',
        `condition` = '{{ glpi_ldap_condition }}',
        use_tls = {{ '1' if glpi_ldap_use_tls else '0' }},
        use_bind = {{ '1' if glpi_ldap_use_bind else '0' }},
        use_dn = {{ '1' if glpi_ldap_use_dn else '0' }},
        email1_field = '{{ glpi_ldap_email1_field }}',
        realname_field = '{{ glpi_ldap_realname_field }}',
        firstname_field = '{{ glpi_ldap_firstname_field }}',
        phone_field = '{{ glpi_ldap_phone_field }}',
        title_field = '{{ glpi_ldap_title_field }}',
        date_mod = NOW();
    dest: /tmp/glpi_ldap_config.sql
    mode: '0644'

- name: Copier le fichier SQL dans le conteneur de base de données
  ansible.builtin.command: docker cp /tmp/glpi_ldap_config.sql glpi_db:/tmp/glpi_ldap_config.sql
  changed_when: true

- name: Exécuter la configuration LDAP via le fichier SQL
  community.docker.docker_container_exec:
    container: glpi_db
    command: bash -c "mariadb -u {{ glpi_mysql_user }} -p{{ glpi_mysql_password }} {{ glpi_mysql_db }} < /tmp/glpi_ldap_config.sql"
  register: ldap_insert
  changed_when: true

- name: Nettoyer le fichier SQL temporaire sur l'hôte
  ansible.builtin.file:
    path: /tmp/glpi_ldap_config.sql
    state: absent

- name: Nettoyer le fichier SQL temporaire dans le conteneur
  community.docker.docker_container_exec:
    container: glpi_db
    command: rm -f /tmp/glpi_ldap_config.sql
  changed_when: false
  failed_when: false

- name: Afficher le statut de la configuration LDAP
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "Configuration LDAP appliquée avec succès"
      - "Serveur: {{ glpi_ldap_host }}:{{ glpi_ldap_port }}"
      - "Base DN: {{ glpi_ldap_basedn }}"
      - "RootDN: {{ glpi_ldap_rootdn }}"
      - "Login field: {{ glpi_ldap_login_field }}"
      - "TLS: {{ 'Activé' if glpi_ldap_use_tls else 'Désactivé' }}"
      - "Filtre: Exclut comptes désactivés, glpi_bind et Administrateur"
      - "=========================================="
